<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>JLS â€“ UPI QR Payment</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  * {
    box-sizing: border-box;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  body {
    margin: 0;
    padding: 16px;
    background: #ffffff;
    color: #222;
  }
  h1 {
    margin-top: 0;
    font-size: 20px;
    text-align: center;
  }
  .layout {
    display: flex;
    gap: 16px;
    align-items: flex-start;
    justify-content: center;
    max-width: 1200px;
    margin: 0 auto;
    flex-wrap: wrap;
  }
  .panel {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 16px;
    flex: 1;
    min-width: 320px;
  }
  .panel h2 {
    margin-top: 0;
    font-size: 16px;
  }
  label {
    display: block;
    font-size: 13px;
    margin-bottom: 4px;
  }
  input {
    width: 100%;
    padding: 6px 8px;
    margin-bottom: 10px;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 14px;
  }
  button {
    padding: 8px 14px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .btn-primary {
    background: #0052cc;
    color: #fff;
  }
  .btn-success {
    background: #1aa34a;
    color: #fff;
  }
  .btn-fail {
    background: #d93025;
    color: #fff;
  }
  .btn-row {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 12px;
  }
  .qr-wrapper {
    text-align: center;
    padding: 12px;
    border-radius: 8px;
    background: #fafafa;
    border: 1px dashed #ccc;
    min-height: 260px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  #qrCode {
    margin-bottom: 8px;
  }
  #successImage {
    display: none;
    width: 220px;
    margin-bottom: 8px;
  }
  .payment-info {
    font-size: 14px;
    margin-top: 4px;
    line-height: 1.4;
  }
  .status {
    margin-top: 8px;
    font-weight: 600;
    font-size: 14px;
  }
  .status.pending {
    color: #0066cc;
  }
  .status.paid {
    color: #15803d;
  }
  .status.cancelled {
    color: #b91c1c;
  }
  .idle-message {
    font-size: 18px;
    color: #666;
  }
  @media (max-width: 768px) {
    .layout {
      flex-direction: column;
    }
  }
</style>

<!-- QRCode.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
  <h1>JLS â€“ UPI QR Payment</h1>

  <div class="layout">
    <!-- LEFT: Input panel -->
    <div class="panel">
      <h2>Step 1 â€“ Enter Billing Details</h2>

      <label for="companyLine">
        Company line from Busy or type J / C
        <span style="font-weight: normal; font-size: 12px;">
          (e.g. <i>JLS Trading Co. (2025-26) (COMP0005)</i> or just <b>J</b> / <b>C</b>)
        </span>
      </label>
      <input id="companyLine" type="text"
             placeholder="JLS Trading Co. (2025-26) (COMP0005) or J / C" />

      <label for="invoiceNo">Invoice / Vch. No.</label>
      <input id="invoiceNo" type="text" placeholder="26213" />

      <label for="amount">Amount (â‚¹)</label>
      <input id="amount" type="number" min="0" step="0.01" placeholder="90.00" />

      <button id="generateBtn" class="btn-primary" type="button">
        Generate QR
      </button>

      <p style="font-size: 12px; color:#666; margin-top:8px;">
        Note: While a QR is visible, you must click <b>SUCCESS</b> or <b>FAILURE</b>
        before generating the next one. This prevents mixing customers.
      </p>
    </div>

    <!-- RIGHT: QR / status panel -->
    <div class="panel">
      <h2>Step 2 â€“ Show QR to Customer</h2>

      <div id="qrArea" class="qr-wrapper">
        <div id="idleState" class="idle-message">
          Waiting for QRâ€¦
        </div>

        <!-- QR placeholder -->
        <div id="qrCode" style="display:none;"></div>

        <!-- JLS success image -->
        <img id="successImage"
             src="https://raw.githubusercontent.com/kgangola/jls-qr-payment/main/image.png" />

        <div id="paymentDetails" class="payment-info" style="display:none;"></div>
        <div id="statusText" class="status" style="display:none;"></div>
      </div>

      <div class="btn-row">
        <button id="successBtn" class="btn-success" type="button" disabled>
          SUCCESS
        </button>
        <button id="failBtn" class="btn-fail" type="button" disabled>
          FAILURE
        </button>
      </div>
    </div>
  </div>

<script>
// Company â†’ VPA mapping
const COMPANY_TO_VPA = {
  "JLS TRADING CO": "paytmqr2810050501011pn54jpiri49@paytm",
  "JIWAN LAL SAH GANGOLA & SONS": "paytmqr2810050501011ni90w28cwja@paytm"
};

let currentPayment = null;
let qrInstance = null;

// Normalize Busy company line OR shortcut J/C
function normalizeCompanyName(raw) {
  if (!raw) return "";
  let base = raw.trim().toUpperCase();

  // Shortcuts
  if (base === "J") return "JLS TRADING CO";
  if (base === "C") return "JIWAN LAL SAH GANGOLA & SONS";

  // take text before first "("
  base = base.split("(")[0];
  base = base.replace(/\s+/g, " ").trim();
  base = base.toUpperCase();
  base = base.replace(/\./g, "");
  return base;
}

function getVpaForCompany(normalized) {
  if (COMPANY_TO_VPA[normalized]) return COMPANY_TO_VPA[normalized];
  if (normalized.includes("JLS TRADING")) return COMPANY_TO_VPA["JLS TRADING CO"];
  if (normalized.includes("JIWAN LAL SAH GANGOLA")) return COMPANY_TO_VPA["JIWAN LAL SAH GANGOLA & SONS"];
  return null;
}

function buildUpiUrl(vpa, payeeName, amount) {
  const pa = encodeURIComponent(vpa);
  const pn = encodeURIComponent(payeeName);
  const am = encodeURIComponent(amount.toString());
  return `upi://pay?pa=${pa}&pn=${pn}&am=${am}&cu=INR`;
}

// UI elements
const companyInput = document.getElementById("companyLine");
const invoiceInput = document.getElementById("invoiceNo");
const amountInput = document.getElementById("amount");
const generateBtn = document.getElementById("generateBtn");

const qrCodeDiv = document.getElementById("qrCode");
const idleState = document.getElementById("idleState");
const paymentDetails = document.getElementById("paymentDetails");
const statusText = document.getElementById("statusText");

const successBtn = document.getElementById("successBtn");
const failBtn = document.getElementById("failBtn");
const successImage = document.getElementById("successImage");

function setIdleScreen() {
  currentPayment = null;
  if (qrInstance) {
    qrInstance.clear();
  }
  qrCodeDiv.innerHTML = "";
  qrCodeDiv.style.display = "none";
  successImage.style.display = "none";

  idleState.style.display = "block";
  paymentDetails.style.display = "none";
  statusText.style.display = "none";
  successBtn.disabled = true;
  failBtn.disabled = true;
}

function setPendingScreen(payment) {
  idleState.style.display = "none";
  qrCodeDiv.style.display = "block";
  successImage.style.display = "none";
  paymentDetails.style.display = "block";
  statusText.style.display = "block";

  paymentDetails.innerHTML =
    `Invoice: <b>${payment.invoice}</b><br>` +
    `Company: <b>${payment.companyDisplay}</b><br>` +
    `Amount: <b>â‚¹ ${payment.amount}</b>`;

  // ðŸ”Š Soundbox announcement status
  statusText.textContent = "Status: Soundbox Announcement";
  statusText.className = "status pending";

  successBtn.disabled = false;
  failBtn.disabled = false;
}

// SUCCESS / FAILURE
function markPayment(status) {
  if (!currentPayment || currentPayment.status !== "PENDING") return;
  currentPayment.status = status;

  if (status === "PAID") {
    // Hide QR, show success image
    qrCodeDiv.style.display = "none";
    successImage.style.display = "block";

    statusText.textContent = "Status: PAYMENT RECEIVED";
    statusText.className = "status paid";

    // Hold success screen for 10 seconds
    setTimeout(setIdleScreen, 10000);

  } else {
    // Failure: keep QR (or you can hide if you prefer)
    statusText.textContent = "Status: PAYMENT FAILED";
    statusText.className = "status cancelled";

    // Quick reset on failure
    setTimeout(setIdleScreen, 800);
  }
}

// Generate QR
generateBtn.addEventListener("click", () => {
  if (currentPayment && currentPayment.status === "PENDING") {
    alert("A payment is already pending. Please click SUCCESS or FAILURE before starting the next customer.");
    return;
  }

  const rawCompany = companyInput.value.trim();
  const invoice = invoiceInput.value.trim();
  const amountStr = amountInput.value.trim();

  if (!rawCompany) {
    alert("Please paste the company line from Busy or type J / C.");
    return;
  }
  if (!invoice) {
    alert("Please enter the Invoice / Vch. No.");
    return;
  }
  if (!amountStr || Number(amountStr) <= 0) {
    alert("Please enter a valid amount.");
    return;
  }

  const normalizedName = normalizeCompanyName(rawCompany);
  const vpa = getVpaForCompany(normalizedName);
  if (!vpa) {
    alert("Could not identify company. Check spelling or use J / C.");
    return;
  }

  const companyDisplay = rawCompany.split("(")[0].trim() || normalizedName;
  const amount = Number(amountStr).toFixed(2);
  const upiUrl = buildUpiUrl(vpa, companyDisplay, amount);

  currentPayment = {
    invoice,
    amount,
    companyDisplay,
    companyNormalized: normalizedName,
    vpa,
    upiUrl,
    status: "PENDING"
  };

  // Create QR
  qrCodeDiv.innerHTML = "";
  qrInstance = new QRCode(qrCodeDiv, {
    text: upiUrl,
    width: 220,
    height: 220
  });

  setPendingScreen(currentPayment);
});

// SUCCESS / FAILURE buttons
successBtn.addEventListener("click", () => markPayment("PAID"));
failBtn.addEventListener("click", () => markPayment("CANCELLED"));

// Initial idle screen
setIdleScreen();
</script>

</body>
</html>
